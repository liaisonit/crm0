<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEADNEST - Sales CRM</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.378.0/dist/umd/lucide.min.js"></script>

    <style>
        /* Custom Styles for a high-class, professional UI */
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f8f9fa;
            color: #212529;
            font-weight: 400; 
        }
        .nav-link {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #6c757d;
            transition: background-color 0.2s, color 0.2s;
        }
        .nav-link:hover {
            background-color: #f1f3f5;
            color: #212529;
        }
        .nav-link.active {
            background-color: #e9ecef;
            color: #212529;
            font-weight: 600;
        }
        .action-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 16px; 
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid #dee2e6;
            background-color: white;
            transition: all 0.2s;
            line-height: 1;
        }
        .action-button:hover {
            border-color: #adb5bd;
            background-color: #f8f9fa;
        }
        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .primary-action-btn {
             background-color: #212529;
             color: white;
             border-color: #212529;
        }
        .primary-action-btn:hover {
            background-color: #343a40;
        }
        .fab-menu-item {
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            opacity: 0;
            transform: translateY(20px) scale(0.5);
            transform-origin: bottom right;
        }
        .fab-menu-item.open {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        .detail-action-button {
            justify-content: flex-start;
            width: 100%;
            font-weight: 500;
        }
        .fab-blur-overlay {
            transition: background-color 0.3s;
        }
        .input-error {
            border-color: #ef4444 !important;
        }
        .auth-toggle-btn {
            flex: 1;
            padding: 6px; 
            font-weight: 600;
            font-size: 14px;
            transition: color 0.3s ease-in-out;
            border-radius: 8px;
            z-index: 10;
        }
        .auth-toggle-btn.active {
            color: #111827;
        }
        .auth-form {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s;
            position: absolute;
            width: 100%;
        }
        .auth-form.active {
            opacity: 1;
            visibility: visible;
            position: relative;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .auth-form.active {
            animation: fadeIn 0.4s ease-in-out forwards;
        }
        
        /* Lead Card Styles */
        .lead-card {
            background-color: white;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            padding: 24px;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
            opacity: 0;
            transform: translateY(20px);
            animation: card-fade-in 0.5s ease-out forwards;
        }
        .lead-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }
        @keyframes card-fade-in {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-active { background-color: #e0f2fe; color: #0c4a6e; }
        .status-cold { background-color: #e0e7ff; color: #3730a3; }
        .status-won { background-color: #dcfce7; color: #166534; }
        .status-lost { background-color: #fee2e2; color: #991b1b; }

        #modal-content {
            background-color: #f8f9fa;
            animation: modal-slide-down 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        @keyframes modal-slide-down {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .profile-dropdown {
            transition: opacity 0.2s, transform 0.2s;
        }
        .lead-tab {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .lead-tab.active {
            background-color: #374151;
            color: white;
        }
        .faq-item .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        .faq-item.open .faq-answer {
            max-height: 200px; /* Adjust as needed */
        }
        .faq-item.open .faq-chevron {
            transform: rotate(180deg);
        }
        .faq-chevron {
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="text-gray-800 antialiased">

    <!-- Auth Screen -->
    <div id="auth-screen" class="w-screen h-screen flex items-center justify-center bg-gray-100 p-4">
        <div class="w-full max-w-md">
            <div class="bg-white p-8 rounded-lg shadow-md">
                <div class="text-center mb-6">
                    <h1 class="text-2xl text-gray-800 tracking-wider">
                        <span class="font-light">LEAD</span><span class="font-extrabold">NEST</span>
                    </h1>
                     <p class="text-sm text-gray-500 mt-2 font-light">Manage your leads and appointments efficiently</p>
                </div>
                <!-- Auth Forms will be injected here -->
                <div id="auth-forms"></div>
                 <p class="text-center text-xs text-gray-400 mt-6 font-light">© 2024-25 No-NonSence CRM • Crafted with lot of ♥ by AM.</p>
            </div>
        </div>
    </div>

    <!-- App Screen (Initially hidden) -->
    <div id="app-screen" class="hidden">
        <div id="app-container" class="flex flex-col h-screen w-screen">
            <!-- Header Navigation -->
            <header class="bg-white border-b border-gray-200 px-8 z-20">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center space-x-8">
                        <h1 class="text-xl text-gray-800 tracking-wider">
                            <span class="font-light">LEAD</span><span class="font-extrabold">NEST</span>
                        </h1>
                        <nav id="top-nav" class="flex items-center space-x-2"></nav>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="profile-menu-container" class="relative">
                            <button id="profile-menu-button" class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center text-white font-bold text-sm uppercase">
                                AB
                            </button>
                            <div id="profile-menu-dropdown" class="profile-dropdown absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 border border-gray-200 origin-top-right transform scale-95 opacity-0 hidden">
                                <a href="#" id="profile-settings-link" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Settings</a>
                                <a href="#" id="help-link" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Help & Support</a>
                                <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content Area -->
            <main id="main-content" class="flex-1 overflow-y-auto p-8 px-[3%]"></main>
        </div>

        <!-- FAB Blur Overlay -->
        <div id="fab-blur-overlay" class="fab-blur-overlay fixed inset-0 z-20 hidden" style="backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); background-color: rgba(248, 249, 250, 0.5);"></div>

        <!-- Floating Action Button (FAB) -->
        <div id="fab-container" class="fixed z-30" style="bottom: 3%; right: 3%;">
            <div id="fab-menu" class="flex flex-col items-end space-y-3 mb-3">
                 <div id="fab-ai-assistant" class="fab-menu-item flex items-center"><span class="text-sm font-semibold bg-white py-1 px-3 rounded-md shadow-md mr-3">AI Assistant</span><button class="action-button primary-action-btn rounded-full p-3 shadow-lg bg-purple-600 border-purple-600 hover:bg-purple-500"><i data-lucide="sparkles" class="w-5 h-5"></i></button></div>
                 <div id="fab-log-interaction" class="fab-menu-item flex items-center"><span class="text-sm font-semibold bg-white py-1 px-3 rounded-md shadow-md mr-3">Log Interaction</span><button class="action-button primary-action-btn rounded-full p-3 shadow-lg bg-blue-600 border-blue-600 hover:bg-blue-500"><i data-lucide="message-square-plus" class="w-5 h-5"></i></button></div>
                 <div id="fab-new-appointment" class="fab-menu-item flex items-center"><span class="text-sm font-semibold bg-white py-1 px-3 rounded-md shadow-md mr-3">New Appointment</span><button class="action-button primary-action-btn rounded-full p-3 shadow-lg bg-green-600 border-green-600 hover:bg-green-500"><i data-lucide="calendar-plus" class="w-5 h-5"></i></button></div>
                 <div id="fab-new-lead" class="fab-menu-item flex items-center"><span class="text-sm font-semibold bg-white py-1 px-3 rounded-md shadow-md mr-3">New Lead</span><button class="action-button primary-action-btn rounded-full p-3 shadow-lg"><i data-lucide="user-plus" class="w-5 h-5"></i></button></div>
            </div>
            <button id="fab-main-btn" class="bg-gray-800 text-white rounded-full p-4 shadow-xl hover:bg-gray-700 transition-transform transform hover:rotate-45"><i data-lucide="grip" class="w-6 h-6"></i></button>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-2xl"></div>
    </div>


    <!-- Firebase and App Logic -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, query, updateDoc, where, getDocs, getDoc, arrayUnion, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- USER PROVIDED CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAfKTCdFaQTNXoIEzDoDCboxd5K1SWEbH4",
            authDomain: "n0bugs.firebaseapp.com",
            projectId: "n0bugs",
            storageBucket: "n0bugs.appspot.com",
            messagingSenderId: "739782684561",
            appId: "1:739782684561:web:f7009a645514b71c193430",
            measurementId: "G-2M80VXS52R"
        };
        
        // --- GLOBAL APP STATE ---
        let db, auth, userId, currentUserRole;
        let currentCalendarDate = new Date();
        
        // --- DOM ELEMENTS ---
        const mainContent = document.getElementById('main-content');
        const topNav = document.getElementById('top-nav');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContent = document.getElementById('modal-content');
        const fabBlurOverlay = document.getElementById('fab-blur-overlay');
        const authScreen = document.getElementById('auth-screen');
        const appScreen = document.getElementById('app-screen');
        const authForms = document.getElementById('auth-forms');
        
        // --- ROBUST ERROR HANDLING ---
        const displayError = (message, error) => {
            console.error(message, error);
            const errorDiv = document.getElementById('auth-error') || document.createElement('div');
            errorDiv.id = 'auth-error';
            errorDiv.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mt-4 text-sm';
            
            if (error?.code === 'auth/network-request-failed') {
                errorDiv.textContent = 'Network error. Please check your internet connection and try again.';
            } else if (error?.code === 'auth/invalid-credential') {
                errorDiv.textContent = 'Invalid email or password. Please try again.';
            } else if (error?.code === 'auth/email-already-in-use') {
                errorDiv.innerHTML = 'This email is already registered. <a href="#" id="error-show-login" class="font-semibold underline">Please log in.</a>';
            } else {
                errorDiv.textContent = error?.message?.replace('Firebase: ', '') || 'An unknown error occurred.';
            }
            
            const formContainer = document.getElementById('auth-form-container');
            if(formContainer) {
                const existingError = formContainer.querySelector('#auth-error');
                if (existingError) {
                    existingError.remove();
                }
                formContainer.appendChild(errorDiv);
            }
            
            const errorLoginLink = document.getElementById('error-show-login');
            if (errorLoginLink) {
                errorLoginLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    renderAuthContainer(true);
                });
            }
        };

        // --- AUTHENTICATION FLOW ---
        const renderAuthContainer = (isLogin = true) => {
            authForms.innerHTML = `
                <div class="relative flex bg-gray-100 rounded-lg p-1 mb-6">
                    <div id="auth-slider" class="absolute bg-white rounded-md shadow-md transition-all duration-500 ease-in-out" style="width: calc(50% - 4px); left: ${isLogin ? '4px' : '50%'}; top: 4px; bottom: 4px; transition-timing-function: cubic-bezier(0.68, -0.55, 0.27, 1.55);"></div>
                    <button id="login-toggle" class="auth-toggle-btn relative z-10 ${isLogin ? 'active' : ''}">Login</button>
                    <button id="register-toggle" class="auth-toggle-btn relative z-10 ${!isLogin ? 'active' : ''}">Register</button>
                </div>
                <div id="auth-form-container" class="relative" style="min-height: 220px;"></div>
            `;
            
            const slider = document.getElementById('auth-slider');
            const formContainer = document.getElementById('auth-form-container');

            const showForm = (isLogin) => {
                const existingForm = formContainer.querySelector('.auth-form');
                if(existingForm) {
                    existingForm.classList.remove('active');
                }
                
                setTimeout(() => {
                    formContainer.innerHTML = ''; // Clear previous form
                    const formWrapper = document.createElement('div');
                    formWrapper.className = 'auth-form';
                    formContainer.appendChild(formWrapper);

                    if(isLogin) {
                        formWrapper.innerHTML = `
                            <form id="login-form" class="space-y-4">
                                <div><label class="text-xs font-medium text-gray-600">Email</label><input name="email" type="email" placeholder="your@email.com" class="w-full p-3 border border-gray-300 rounded-lg mt-1 font-light text-sm" required></div>
                                <div><label class="text-xs font-medium text-gray-600">Password</label><input name="password" type="password" placeholder="******" class="w-full p-3 border border-gray-300 rounded-lg mt-1 font-light text-sm" required></div>
                                <button type="submit" class="w-full primary-action-btn p-3 rounded-lg">Login</button>
                            </form>
                        `;
                        document.getElementById('login-form').addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const email = e.target.email.value.trim();
                            const password = e.target.password.value;
                            
                            if (!email) {
                                displayError("Login Failed", { message: "Email address cannot be empty." });
                                return;
                            }
                            if (!validateEmail(email)) { 
                                displayError("Login Failed", { message: "Please enter a valid email address." }); 
                                return; 
                            }
                            
                            try { 
                                await signInWithEmailAndPassword(auth, email, password); 
                            } catch (error) { 
                                displayError("Login Failed", error); 
                            }
                        });
                    } else {
                         formWrapper.innerHTML = `
                            <form id="signup-form" class="space-y-4">
                                <div><label class="text-xs font-medium text-gray-600">Email</label><input name="email" type="email" placeholder="your@email.com" class="w-full p-3 border border-gray-300 rounded-lg mt-1 font-light text-sm" required></div>
                                <div><label class="text-xs font-medium text-gray-600">Password</label><input name="password" type="password" placeholder="******" class="w-full p-3 border border-gray-300 rounded-lg mt-1 font-light text-sm" required></div>
                                <button type="submit" class="w-full primary-action-btn p-3 rounded-lg">Register</button>
                            </form>
                        `;
                        document.getElementById('signup-form').addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const email = e.target.email.value.trim();
                            const password = e.target.password.value;

                            if (!email) {
                                displayError("Sign Up Failed", { message: "Email address cannot be empty." });
                                return;
                            }
                            if (!validateEmail(email)) { 
                                displayError("Sign Up Failed", { message: "Please enter a valid email address." }); 
                                return; 
                            }

                            try {
                                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                                const name = email.split('@')[0];
                                await updateProfile(userCredential.user, { displayName: name });
                                await setDoc(doc(db, "users", userCredential.user.uid), { email: email, role: 'agent', displayName: name, createdAt: new Date() });
                            } catch (error) { 
                                displayError("Sign Up Failed", error); 
                            }
                        });
                    }
                    setTimeout(() => formWrapper.classList.add('active'), 10);
                }, 150); // Wait for fade out
            }

            showForm(isLogin);

            document.getElementById('login-toggle').addEventListener('click', () => {
                slider.style.left = '4px';
                document.getElementById('login-toggle').classList.add('active');
                document.getElementById('register-toggle').classList.remove('active');
                showForm(true);
            });
            document.getElementById('register-toggle').addEventListener('click', () => {
                slider.style.left = '50%';
                document.getElementById('register-toggle').classList.add('active');
                document.getElementById('login-toggle').classList.remove('active');
                showForm(false);
            });
        };
        
        const validateEmail = (email) => {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(String(email).toLowerCase());
        };
        
        // --- INITIALIZATION ---
        async function initialize() {
            document.documentElement.classList.remove('dark');
            localStorage.removeItem('theme');

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (error) {
                displayError("Firebase initialization failed. Please check your configuration.", error);
                return;
            }
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    const userDocRef = doc(db, "users", userId);
                    let userDoc = await getDoc(userDocRef);

                    if (!userDoc.exists()) {
                        const name = user.email.split('@')[0];
                        await setDoc(userDocRef, {
                            email: user.email,
                            role: 'agent',
                            displayName: user.displayName || name,
                            createdAt: new Date()
                        });
                        userDoc = await getDoc(userDocRef);
                    }

                    currentUserRole = userDoc.data().role;
                    
                    authScreen.classList.add('hidden');
                    appScreen.classList.remove('hidden');
                    
                    setupHeader(user);
                    setupNavigation();
                    renderDashboard();
                    setupFab();
                } else {
                    appScreen.classList.add('hidden');
                    authScreen.classList.remove('hidden');
                    renderAuthContainer();
                }
            });
        }
        
        // --- UI SETUP FUNCTIONS ---
        function setupHeader(user) {
            const profileButton = document.getElementById('profile-menu-button');
            const profileDropdown = document.getElementById('profile-menu-dropdown');
            const settingsLink = document.getElementById('profile-settings-link');
            const helpLink = document.getElementById('help-link');
            const logoutBtn = document.getElementById('logout-btn');

            const displayName = user.displayName || user.email;
            const initials = displayName.split(' ').map(n => n[0]).join('').substring(0, 2);
            profileButton.textContent = initials;

            profileButton.addEventListener('click', (e) => {
                e.stopPropagation();
                const isHidden = profileDropdown.classList.contains('hidden');
                if (isHidden) {
                    profileDropdown.classList.remove('hidden');
                    setTimeout(() => profileDropdown.classList.remove('opacity-0', 'scale-95'), 10);
                } else {
                    profileDropdown.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => profileDropdown.classList.add('hidden'), 200);
                }
            });
            
            settingsLink.addEventListener('click', (e) => {
                e.preventDefault();
                renderSettingsPage();
            });
            helpLink.addEventListener('click', (e) => {
                e.preventDefault();
                renderHelpPage();
            });
            logoutBtn.addEventListener('click', () => signOut(auth));

            window.addEventListener('click', () => {
                if (!profileDropdown.classList.contains('hidden')) {
                    profileDropdown.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => profileDropdown.classList.add('hidden'), 200);
                }
            });
        }
        
        function setupNavigation() {
            const baseNav = [
                { id: 'dashboard', label: 'Dashboard', icon: 'layout-grid' },
                { id: 'active-leads', label: 'Active Leads', icon: 'users' },
                { id: 'all-leads', label: 'All Leads', icon: 'archive' },
                { id: 'appointments', label: 'Appointments', icon: 'calendar' },
                { id: 'reports', label: 'Reports', icon: 'bar-chart-2' },
            ];
            const managerNav = baseNav;
            const agentNav = baseNav;
            const navItems = currentUserRole === 'manager' ? managerNav : agentNav;

            topNav.innerHTML = navItems.map(item => `<a href="#" id="nav-${item.id}" class="nav-link"><i data-lucide="${item.icon}" class="w-4 h-4 mr-2"></i><span>${item.label}</span></a>`).join('');

            const navLinks = topNav.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    const navId = link.id.replace('nav-', '');
                    switch(navId) {
                        case 'dashboard': renderDashboard(); break;
                        case 'active-leads': renderLeadsPage(); break;
                        case 'all-leads': renderAllLeadsPage(); break;
                        case 'appointments': renderAppointmentsPage(); break;
                        case 'settings': renderSettingsPage(); break;
                        case 'reports': renderReportsPage(); break;
                    }
                });
            });

            const dashboardLink = document.getElementById('nav-dashboard');
            if (dashboardLink) {
                dashboardLink.classList.add('active');
            } else if (navLinks.length > 0) {
                navLinks[0].classList.add('active');
            }

            lucide.createIcons();
        }

        function setupFab() {
            const fabMainBtn = document.getElementById('fab-main-btn');
            const fabMenuItems = document.querySelectorAll('.fab-menu-item');
            
            const toggleFabMenu = () => {
                fabMenuItems.forEach(item => item.classList.toggle('open'));
                fabBlurOverlay.classList.toggle('hidden');
            };

            fabMainBtn.addEventListener('click', toggleFabMenu);
            fabBlurOverlay.addEventListener('click', toggleFabMenu);

            document.getElementById('fab-new-lead').addEventListener('click', showAddLeadModal);
            document.getElementById('fab-new-appointment').addEventListener('click', () => showScheduleMeetingModal(null));
            document.getElementById('fab-log-interaction').addEventListener('click', showLogInteractionModal);
            document.getElementById('fab-ai-assistant').addEventListener('click', showAIAssistantModal);
        }
        
        function openModal(content, size = 'max-w-2xl') {
            modalContent.className = `bg-white rounded-lg shadow-xl w-full ${size}`;
            modalContent.innerHTML = content;
            modalBackdrop.classList.remove('hidden');
            modalBackdrop.classList.add('flex');
            lucide.createIcons();
        }

        function closeModal() {
            modalBackdrop.classList.add('hidden');
            modalBackdrop.classList.remove('flex');
            modalContent.innerHTML = '';
        }
        
        function showConfirmModal(title, message, onConfirm) {
            openModal(`<div class="p-8"><h3 class="text-lg font-semibold mb-2">${title}</h3><p class="text-gray-600 mb-6">${message}</p><div class="flex justify-end space-x-3"><button id="cancel-confirm-btn" class="action-button">Cancel</button><button id="confirm-action-btn" class="action-button bg-red-600 text-white hover:bg-red-500 border-red-600">Confirm</button></div></div>`, 'max-w-md');
            document.getElementById('cancel-confirm-btn').addEventListener('click', closeModal);
            document.getElementById('confirm-action-btn').addEventListener('click', onConfirm);
        }
        
        modalBackdrop.addEventListener('click', (e) => { if (e.target === modalBackdrop) closeModal(); });

        function createStatCard(title, value, icon) {
            return `<div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm"><div class="flex items-center justify-between"><span class="text-sm font-medium text-gray-500">${title}</span><i data-lucide="${icon}" class="w-5 h-5 text-gray-400"></i></div><p class="text-4xl font-light text-gray-800 mt-2">${value}</p></div>`;
        }

        function renderDashboard() {
            if (currentUserRole === 'manager') {
                renderManagerDashboard();
            } else {
                renderAgentDashboard();
            }
        }

        async function renderManagerDashboard() {
            mainContent.innerHTML = `<div class="text-center p-10">Loading Manager Dashboard...</div>`;
            if (!userId) return;
            const leadsRef = collection(db, 'users', userId, 'leads');
            
            try {
                const leadsSnapshot = await getDocs(leadsRef);
                
                let totalRevenue = 0, dealsWon = 0, totalDeals = 0, coldLeadsCount = 0;
                const agentPerformance = {};
                const leadSources = {}, funnel = { new: 0, contacted: 0, appointment: 0, won: 0 };

                leadsSnapshot.docs.forEach(doc => {
                    const lead = { id: doc.id, ...doc.data() };
                    totalDeals++;
                    if(lead.status === 'won') { dealsWon++; totalRevenue += lead.leadValue || 0; }
                    if(lead.status === 'cold') coldLeadsCount++;
                    if(lead.status === 'active' && !lead.assignedAgentId) funnel.new++;
                    if(lead.status === 'active' && lead.assignedAgentId && !lead.notes?.length) funnel.contacted++;
                    if(lead.appointments?.length > 0) funnel.appointment++;
                    if(lead.status === 'won') funnel.won++;
                    
                    if(lead.assignedAgentId && lead.assignedAgentName) {
                        if(!agentPerformance[lead.assignedAgentId]) {
                            agentPerformance[lead.assignedAgentId] = { name: lead.assignedAgentName, deals: 0, revenue: 0, won: 0 };
                        }
                        agentPerformance[lead.assignedAgentId].deals++;
                        if(lead.status === 'won') { 
                            agentPerformance[lead.assignedAgentId].won++; 
                            agentPerformance[lead.assignedAgentId].revenue += lead.leadValue || 0; 
                        }
                    }

                    if(lead.leadSource) {
                        if(!leadSources[lead.leadSource]) leadSources[lead.leadSource] = { count: 0, value: 0};
                        leadSources[lead.leadSource].count++;
                        if(lead.status === 'won') leadSources[lead.leadSource].value += lead.leadValue || 0;
                    }
                });

                const winRate = totalDeals > 0 ? ((dealsWon / totalDeals) * 100).toFixed(1) : 0;
                const avgDealSize = dealsWon > 0 ? (totalRevenue / dealsWon).toFixed(0) : 0;
                
                mainContent.innerHTML = `
                    <h2 class="text-3xl font-light text-gray-800 mb-6">Manager Dashboard</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
                        ${createStatCard('Total Revenue', '₹' + totalRevenue.toLocaleString('en-IN'), 'dollar-sign')}
                        ${createStatCard('Win Rate', winRate + '%', 'trophy')}
                        ${createStatCard('Avg. Deal Size', '₹' + avgDealSize.toLocaleString('en-IN'), 'gem')}
                        ${createStatCard('Cold Leads', coldLeadsCount, 'snowflake')}
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 space-y-8">${renderManagerReports(agentPerformance, leadSources)}</div>
                        <div class="h-full">${renderSalesFunnel(funnel)}</div>
                    </div>
                     <div class="mt-8">${renderAIStrategicAssistant()}</div>
                    `;
                lucide.createIcons();
                addAIAssistantListeners();
            } catch (error) { displayError("Could not load Manager Dashboard.", error); }
        }

        async function renderAgentDashboard() {
            mainContent.innerHTML = `<div class="text-center p-10">Loading Agent Dashboard...</div>`;
            if (!userId) return;
            const leadsRef = collection(db, 'users', userId, 'leads');
            const q = query(leadsRef, where("assignedAgentId", "==", auth.currentUser.uid));
            
            try {
                const snapshot = await getDocs(q);
                let activeLeads = 0, appointments = 0, dealsWon = 0;
                snapshot.docs.forEach(doc => {
                    const lead = doc.data();
                    if(lead.status === 'active') activeLeads++;
                    if(lead.appointments) appointments += lead.appointments.length;
                    if(lead.status === 'won') dealsWon++;
                });

                mainContent.innerHTML = `
                     <h2 class="text-3xl font-light text-gray-800 mb-6">My Dashboard</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                        ${createStatCard('My Active Leads', activeLeads, 'user-check')}
                        ${createStatCard('Appointments Booked', appointments, 'calendar')}
                        ${createStatCard('Deals Won', dealsWon, 'award')}
                    </div>
                     <div class="mt-8">${renderAIStrategicAssistant()}</div>
                    `;
                lucide.createIcons();
                addAIAssistantListeners();
            } catch (error) { displayError("Could not load Agent Dashboard.", error); }
        }

        function renderManagerReports(agentData, sourceData) {
            const topAgent = Object.values(agentData).sort((a,b) => b.revenue - a.revenue)[0];
            const sortedSources = Object.entries(sourceData).sort((a,b) => b[1].value - a[1].value);
            return `<div class="bg-white rounded-lg border border-gray-200 shadow-sm p-5"><h3 class="text-xl font-medium text-gray-800 mb-4">Team Performance</h3><p class="font-light mb-2">Top Agent: <span class="font-semibold">${topAgent ? topAgent.name : 'N/A'}</span> with ₹${topAgent ? topAgent.revenue.toLocaleString('en-IN') : 0} in revenue.</p></div><div class="bg-white rounded-lg border border-gray-200 shadow-sm p-5"><h3 class="text-xl font-medium text-gray-800 mb-4">Lead Source Value</h3><div class="space-y-3">${sortedSources.length > 0 ? sortedSources.map(([source, data]) => `<div class="w-full"><div class="flex justify-between text-sm font-medium mb-1"><span>${source}</span><span>₹${data.value.toLocaleString('en-IN')}</span></div><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-blue-600 h-2.5 rounded-full" style="width: ${ (data.value / (sortedSources[0][1].value || 1)) * 100}%"></div></div></div>`).join('') : '<p class="text-center font-light text-gray-500 p-4">No data available.</p>'}</div></div>`;
        }

        function renderSalesFunnel(funnelData) {
            const total = Object.values(funnelData).reduce((sum, val) => sum + val, 0) || 1;
            const colors = { new: 'bg-purple-500', contacted: 'bg-indigo-500', appointment: 'bg-blue-500', won: 'bg-green-500' };
            return `<div class="bg-white rounded-lg border border-gray-200 shadow-sm p-5 h-full flex flex-col">
                        <h3 class="text-xl font-medium text-gray-800 mb-4">Sales Funnel</h3>
                        <div class="flex-grow flex flex-col justify-center space-y-2">
                            ${Object.entries(funnelData).map(([stage, value]) => `
                                <div class="flex items-center">
                                    <span class="w-28 text-sm font-medium text-gray-600 capitalize">${stage}</span>
                                    <div class="flex-grow bg-gray-200 rounded-full h-6 mr-2">
                                        <div class="${colors[stage]} h-6 rounded-full text-white text-xs flex items-center justify-center" style="width: ${ (value / total) * 100}%">${value}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
        }
        
        function renderLeadsPage() {
             const title = "Active Leads";
             mainContent.innerHTML = `<div class="text-center p-10">Loading ${title}...</div>`;
             if (!userId) return;
             
             const leadsRef = collection(db, 'users', userId, 'leads');
             let q;
             if (currentUserRole === 'manager') {
                 q = query(leadsRef, where("status", "==", "active")); 
             } else {
                 q = query(leadsRef, where("status", "==", "active"), where("assignedAgentId", "==", auth.currentUser.uid)); 
             }

             onSnapshot(q, (snapshot) => {
                let leads = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if(currentUserRole === 'manager') {
                    leads = leads.filter(lead => lead.assignedAgentId);
                }

                mainContent.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-light text-gray-800">${title}</h2>
                        <div class="flex items-center space-x-4">
                           <input type="text" placeholder="Search leads..." class="w-full md:w-64 p-3 border border-gray-300 bg-white rounded-lg text-sm font-light">
                        </div>
                    </div>
                    ${renderLeadsGrid(leads)}
                `;
                lucide.createIcons();
                setupLeadInteractions(leads);
             }, (error) => { displayError(`Could not load ${title}.`, error); });
        }

        function renderAllLeadsPage() {
            mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-light text-gray-800">Leads Database</h2>
                    <div class="flex items-center space-x-4">
                       <input type="text" placeholder="Search leads..." class="w-full md:w-64 p-3 border border-gray-300 bg-white rounded-lg text-sm font-light">
                       <button id="header-new-lead-btn" class="action-button primary-action-btn"><i data-lucide="plus" class="w-4 h-4 mr-2"></i>New Lead</button>
                    </div>
                </div>
                <div class="border-b border-gray-200 mb-4">
                    <nav id="leads-tabs" class="-mb-px flex space-x-6" aria-label="Tabs">
                        <a href="#" class="lead-tab active" data-status="new">New</a>
                        <a href="#" class="lead-tab" data-status="cold">Cold</a>
                        <a href="#" class="lead-tab" data-status="won">Won</a>
                        <a href="#" class="lead-tab" data-status="lost">Lost</a>
                    </nav>
                </div>
                <div id="leads-content"></div>
            `;
            
            const tabs = document.querySelectorAll('#leads-tabs .lead-tab');
            let allLeads = []; // Cache all leads

            const leadsRef = collection(db, 'users', userId, 'leads');
            onSnapshot(leadsRef, (snapshot) => {
                allLeads = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const activeTab = document.querySelector('#leads-tabs .lead-tab.active');
                if (activeTab) {
                    renderLeadsByStatus(activeTab.dataset.status, allLeads);
                }
            }, (error) => {
                displayError("Could not load leads.", error);
                document.getElementById('leads-content').innerHTML = `<p class="text-red-500">Error loading leads.</p>`;
            });

            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    renderLeadsByStatus(tab.dataset.status, allLeads);
                });
            });

            document.getElementById('header-new-lead-btn')?.addEventListener('click', showAddLeadModal);
        }

        function renderLeadsByStatus(status, allLeads) {
             const contentArea = document.getElementById('leads-content');
             contentArea.innerHTML = `<div class="text-center p-10">Filtering...</div>`;
             
             let leadsToShow = [];
             if (status === 'new') {
                 leadsToShow = allLeads.filter(lead => lead.status === 'active' && !lead.assignedAgentId);
             } else {
                 leadsToShow = allLeads.filter(lead => lead.status === status);
             }
             
             if (currentUserRole !== 'manager') {
                 leadsToShow = leadsToShow.filter(lead => lead.assignedAgentId === auth.currentUser.uid);
             }

             contentArea.innerHTML = renderLeadsGrid(leadsToShow);
             lucide.createIcons();
             setupLeadInteractions(leadsToShow);
        }

        function renderLeadsGrid(leads) {
             return `<div id="leads-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        ${leads.length > 0 ? leads.map((lead, index) => `
                            <div class="lead-card" data-id="${lead.id}" style="animation-delay: ${index * 50}ms">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="text-lg font-bold text-gray-800">${lead.name}</h3>
                                        <p class="text-sm text-gray-500 font-light">${lead.companyName}</p>
                                    </div>
                                    <span class="status-badge status-${lead.status}">${lead.status}</span>
                                </div>
                                <div class="my-6">
                                    <p class="text-3xl font-light text-gray-900">₹${(lead.leadValue || 0).toLocaleString('en-IN')}</p>
                                    <p class="text-xs text-gray-400 font-light">Lead Value</p>
                                </div>
                                <div class="flex justify-between items-center">
                                    <div class="text-sm">
                                        <span class="font-semibold text-gray-600">Assigned:</span>
                                        <span class="font-light text-gray-500">${lead.assignedAgentName || 'Unassigned'}</span>
                                    </div>
                                    ${currentUserRole === 'manager' && !lead.assignedAgentId && lead.status === 'active' ? `<button class="action-button assign-lead-btn text-xs py-2 px-3" data-id="${lead.id}" data-name="${lead.name}"><i data-lucide="user-check" class="w-4 h-4 mr-2"></i>Assign</button>` : ''}
                                </div>
                            </div>
                        `).join('') : `<p class="col-span-full text-center p-12 text-gray-500 font-light">No leads found in this category.</p>`}
                    </div>`;
        }
        
        async function renderLeadDetailView(leadId) {
            const leadRef = doc(db, 'users', userId, 'leads', leadId);
            const leadSnap = await getDoc(leadRef);
            if (!leadSnap.exists()) { mainContent.innerHTML = `<div class="text-center p-10">Lead not found.</div>`; return; }
            const lead = { id: leadSnap.id, ...leadSnap.data() };
            openModal(`<div class="p-8 bg-gray-50 rounded-xl"><div class="flex justify-between items-start mb-6"><div><h3 class="text-2xl font-bold text-gray-800">${lead.name}</h3><p class="text-gray-500 font-medium">${lead.companyName} - <span class="font-bold text-blue-600">₹${(lead.leadValue || 0).toLocaleString('en-IN')}</span></p></div><button id="close-modal-btn" class="p-2 rounded-full hover:bg-gray-200 text-gray-500 hover:text-gray-800 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="grid grid-cols-1 md:grid-cols-3 gap-8"><div class="md:col-span-1 space-y-6"><div class="bg-white p-4 rounded-xl shadow-sm border"><h4 class="text-sm font-semibold text-gray-500 uppercase mb-3 tracking-wider">Details</h4><div class="space-y-3 text-sm"><div class="flex items-center"><i data-lucide="mail" class="w-4 h-4 mr-3 text-gray-400"></i><span class="font-light">${lead.email}</span></div><div class="flex items-center"><i data-lucide="phone" class="w-4 h-4 mr-3 text-gray-400"></i><span class="font-light">${lead.phone}</span></div><div class="flex items-center"><i data-lucide="globe" class="w-4 h-4 mr-3 text-gray-400"></i><span class="font-light">${lead.country || 'N/A'}</span></div><div class="flex items-center"><i data-lucide="flag" class="w-4 h-4 mr-3 text-gray-400"></i><span class="font-light">${lead.leadSource || 'N/A'}</span></div><div class="flex items-center"><i data-lucide="info" class="w-4 h-4 mr-3 text-gray-400"></i><span class="status-badge status-${lead.status}">${lead.status}</span></div></div></div><div class="bg-white p-4 rounded-xl shadow-sm border"><h4 class="text-sm font-semibold text-gray-500 uppercase mb-3 tracking-wider">Actions</h4><div class="flex flex-col space-y-2"><button class="action-button detail-action-button schedule-meeting-btn" data-id="${lead.id}" data-email="${lead.email}"><i data-lucide="calendar-plus" class="w-4 h-4 mr-2"></i>Schedule Meeting</button><button class="action-button detail-action-button mark-won-btn" data-id="${lead.id}"><i data-lucide="award" class="w-4 h-4 mr-2"></i>Mark as Won</button><button class="action-button detail-action-button mark-cold-btn" data-id="${lead.id}"><i data-lucide="snowflake" class="w-4 h-4 mr-2"></i>Mark as Cold</button><button class="action-button detail-action-button mark-lost-btn" data-id="${lead.id}"><i data-lucide="x-circle" class="w-4 h-4 mr-2"></i>Mark as Lost</button></div></div></div><div class="md:col-span-2 bg-white p-4 rounded-xl shadow-sm border"><h4 class="text-sm font-semibold text-gray-500 uppercase mb-3 tracking-wider">Call Notes</h4><div id="notes-list" class="space-y-3 max-h-64 overflow-y-auto pr-2 mb-4">${lead.notes?.map(note => `<div class="bg-gray-50 p-3 rounded-lg text-sm border"><p class="font-light">${note.text}</p><p class="text-xs text-gray-400 mt-2 text-right">${new Date(note.timestamp.seconds * 1000).toLocaleString()}</p></div>`).join('') || '<p class="text-sm text-gray-400 font-light">No notes yet.</p>'}</div><textarea id="new-note-text" class="w-full p-3 border border-gray-300 bg-gray-50 rounded-lg font-light" placeholder="Add a new call note..."></textarea><button id="add-note-btn" data-id="${lead.id}" class="action-button primary-action-btn mt-2 w-full">Add Note</button></div></div></div>`, 'max-w-4xl');
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            document.getElementById('add-note-btn').addEventListener('click', addNote);
            document.querySelector('.schedule-meeting-btn').addEventListener('click', (e) => showScheduleMeetingModal(e.currentTarget.dataset.id, e.currentTarget.dataset.email));
            document.querySelector('.mark-won-btn').addEventListener('click', (e) => showMarkAsWonModal(e.currentTarget.dataset.id));
            document.querySelector('.mark-lost-btn').addEventListener('click', (e) => {
                updateLeadStatus(e.currentTarget.dataset.id, { status: 'lost' }).then(() => {
                    closeModal();
                    document.querySelector('.nav-link.active')?.click();
                });
            });
            document.querySelector('.mark-cold-btn').addEventListener('click', (e) => {
                showConfirmModal('Mark as Cold?', 'This will trigger the AI nurturing sequence.', () => {
                    updateLeadStatus(lead.id, { status: 'cold' }).then(() => {
                        closeModal(); // Close the confirm modal first
                        triggerAINurturing(lead);
                        document.querySelector('.nav-link.active')?.click();
                    });
                });
            });
        }
        
        async function renderAppointmentsPage() {
            mainContent.innerHTML = `<div class="text-center p-10">Loading Appointments...</div>`;
            if (!userId) return;
            const leadsRef = collection(db, 'users', userId, 'leads');
            const q = query(leadsRef, where("appointments", "!=", null));
            const snapshot = await getDocs(q);
            const allAppointments = [];
            snapshot.docs.forEach(doc => {
                const lead = doc.data();
                if (currentUserRole === 'agent' && lead.assignedAgentId !== auth.currentUser.uid) return;
                lead.appointments.forEach(appt => { allAppointments.push({ ...appt, leadName: lead.name, companyName: lead.companyName }); });
            });
            mainContent.innerHTML = `<h2 class="text-3xl font-light text-gray-800 mb-6">Scheduled Appointments</h2><div class="bg-white rounded-lg border border-gray-200 shadow-sm p-5">${allAppointments.length > 0 ? allAppointments.map(appt => `<div class="border-b border-gray-200 last:border-b-0 py-4"><p class="font-semibold">${new Date(appt.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} at ${new Date(appt.date).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</p><p class="text-sm text-gray-700 font-light mt-1">${appt.notes}</p><p class="text-xs text-gray-500 mt-2">With: ${appt.leadName} (${appt.companyName})</p></div>`).join('') : '<p class="text-center p-12 text-gray-500 font-light">No appointments scheduled.</p>'}</div>`;
        }
        
        async function renderSettingsPage() {
            mainContent.innerHTML = `<h2 class="text-3xl font-light text-gray-800 mb-6">Settings</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <div class="md:col-span-1">
                        <div id="settings-nav" class="flex flex-col space-y-1">
                            <a href="#" class="nav-link active" data-target="profile-settings">Profile</a>
                            <a href="#" class="nav-link" data-target="security-settings">Security</a>
                            ${currentUserRole === 'manager' ? `<a href="#" class="nav-link" data-target="team-settings">Team Management</a>` : ''}
                        </div>
                    </div>
                    <div id="settings-content" class="md:col-span-3">
                        <!-- Content will be injected here -->
                    </div>
                </div>`;
            
            const settingsNavLinks = document.querySelectorAll('#settings-nav .nav-link');
            const settingsContent = document.getElementById('settings-content');

            const renderSettingsTab = async (target) => {
                settingsNavLinks.forEach(l => l.classList.remove('active'));
                document.querySelector(`[data-target="${target}"]`).classList.add('active');

                let content = '';
                switch(target) {
                    case 'profile-settings':
                        content = `<div class="bg-white p-6 rounded-lg border border-gray-200">
                            <h3 class="text-lg font-semibold mb-4">Profile Information</h3>
                            <form id="profile-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Display Name</label>
                                    <input type="text" name="displayName" value="${auth.currentUser.displayName || ''}" class="mt-1 block w-full p-3 border border-gray-300 bg-white rounded-md shadow-sm">
                                </div>
                                <div class="text-right">
                                    <button type="submit" class="action-button primary-action-btn">Save Changes</button>
                                </div>
                            </form>
                        </div>`;
                        break;
                    case 'security-settings':
                        content = `<div class="bg-white p-6 rounded-lg border border-gray-200">
                            <h3 class="text-lg font-semibold mb-4">Change Password</h3>
                            <form id="password-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">New Password</label>
                                    <input type="password" name="newPassword" class="mt-1 block w-full p-3 border border-gray-300 bg-white rounded-md shadow-sm" required>
                                </div>
                                <div class="text-right">
                                    <button type="submit" class="action-button primary-action-btn">Update Password</button>
                                </div>
                            </form>
                        </div>`;
                        break;
                    case 'team-settings':
                         try {
                            const usersRef = collection(db, 'users');
                            const snapshot = await getDocs(query(usersRef, where("role", "==", "agent")));
                            const agents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            content = `<div class="bg-white p-6 rounded-lg border border-gray-200">
                                <h3 class="text-lg font-semibold mb-4">Team Management</h3>
                                <div class="space-y-3">
                                    ${agents.map(agent => `<div class="flex items-center justify-between p-3 border rounded-md">
                                        <div>
                                            <p class="font-semibold">${agent.displayName || agent.email}</p>
                                            <p class="text-xs text-gray-500">${agent.email}</p>
                                        </div>
                                        <button class="action-button elevate-btn" data-id="${agent.id}">Elevate to Manager</button>
                                    </div>`).join('')}
                                </div>
                            </div>`;
                        } catch (e) {
                             content = `<div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-700 p-4 rounded-md" role="alert">
                                <p class="font-bold">Permission Required</p>
                                <p>Could not load team members. Your Firestore security rules may need to be updated to allow managers to view other users.</p>
                            </div>`;
                        }
                        break;
                }
                settingsContent.innerHTML = content;
                lucide.createIcons();
                addSettingsEventListeners(target);
            };

            settingsNavLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    renderSettingsTab(e.currentTarget.dataset.target);
                });
            });

            // Initial tab render
            renderSettingsTab('profile-settings');
        }

        function addSettingsEventListeners(target) {
            if (target === 'profile-settings') {
                document.getElementById('profile-form')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newName = e.target.displayName.value;
                    await updateProfile(auth.currentUser, { displayName: newName });
                    await updateDoc(doc(db, "users", auth.currentUser.uid), { displayName: newName });
                    alert('Profile updated!');
                    setupHeader(auth.currentUser); // Refresh header with new initials
                });
            }
            if (target === 'security-settings') {
                document.getElementById('password-form')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newPassword = e.target.newPassword.value;
                    try {
                        await updatePassword(auth.currentUser, newPassword);
                        alert('Password updated successfully!');
                    } catch (error) {
                        displayError("Password update failed.", error);
                    }
                });
            }
            if (target === 'team-settings') {
                document.querySelectorAll('.elevate-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userIdToElevate = e.currentTarget.dataset.id;
                        showConfirmModal('Elevate User?', 'Are you sure you want to promote this agent to manager?', async () => {
                            await updateDoc(doc(db, "users", userIdToElevate), { role: 'manager' });
                            closeModal();
                            renderSettingsPage();
                        });
                    });
                });
            }
        }

        function setupLeadInteractions(leads) {
            document.querySelectorAll('.lead-card').forEach(card => { 
                card.addEventListener('click', (e) => { 
                    if (!e.target.closest('.assign-lead-btn')) {
                        renderLeadDetailView(e.currentTarget.dataset.id);
                    }
                }); 
            });
            document.querySelectorAll('.assign-lead-btn').forEach(btn => { 
                btn.addEventListener('click', (e) => { 
                    e.stopPropagation();
                    const leadId = e.currentTarget.dataset.id; 
                    const leadName = e.currentTarget.dataset.name;
                    showAssignLeadModal(leadId, leadName);
                }); 
            });
            document.getElementById('header-new-lead-btn')?.addEventListener('click', showAddLeadModal);
        }
        
        const updateLeadStatus = (id, dataToUpdate) => {
            const leadRef = doc(db, 'users', userId, 'leads', id);
            return updateDoc(leadRef, dataToUpdate);
        };
        
        async function addNote(e) {
            const leadId = e.currentTarget.dataset.id;
            const noteText = document.getElementById('new-note-text').value;
            if (!noteText.trim()) return;
            const leadRef = doc(db, 'users', userId, 'leads', leadId);
            const newNote = { text: noteText, timestamp: new Date() };
            await updateDoc(leadRef, { notes: arrayUnion(newNote) });
            renderLeadDetailView(leadId); // Re-render the detail view to show the new note
        }

        function showMarkAsWonModal(leadId) {
            openModal(`<div class="p-8"><h3 class="text-lg font-semibold mb-2">Mark Lead as Won</h3><p class="text-gray-600 mb-6">Enter the final revenue for this deal.</p>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-600 mb-1">Final Revenue (₹)</label>
                    <input id="final-revenue" type="number" placeholder="50000" class="w-full p-3 border border-gray-300 bg-white rounded-md font-light">
                </div>
                <div class="flex justify-end space-x-3 mt-8">
                    <button type="button" id="cancel-modal-btn" class="action-button">Cancel</button>
                    <button type="submit" id="confirm-won-btn" class="action-button primary-action-btn">Confirm Win</button>
                </div>
            </div>`, 'max-w-md');

            document.getElementById('cancel-modal-btn').addEventListener('click', closeModal);
            document.getElementById('confirm-won-btn').addEventListener('click', () => {
                const revenueInput = document.getElementById('final-revenue');
                const revenue = parseFloat(revenueInput.value);
                if (!revenue || revenue < 0) {
                    revenueInput.classList.add('input-error');
                    return;
                }
                updateLeadStatus(leadId, { status: 'won', leadValue: revenue }).then(() => {
                    closeModal();
                    document.querySelector('.nav-link.active')?.click();
                });
            });
        }

        async function showAssignLeadModal(leadId, leadName) {
            const usersRef = collection(db, 'users');
            const q = query(usersRef, where("role", "==", "agent"));
            
            try {
                const snapshot = await getDocs(q);
                const agents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                openModal(`<div class="p-8"><h3 class="text-lg font-semibold mb-2">Assign Lead</h3><p class="text-gray-600 mb-6">Assign "${leadName}" to an agent.</p>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-600 mb-1">Select Agent</label>
                        <select id="agent-select" class="w-full p-3 border border-gray-300 bg-white rounded-md font-light">
                            <option value="">-- Select an Agent --</option>
                            ${agents.map(agent => `<option value="${agent.id}" data-name="${agent.displayName || agent.email.split('@')[0]}">${agent.displayName || agent.email.split('@')[0]}</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3 mt-8">
                        <button type="button" id="cancel-modal-btn" class="action-button">Cancel</button>
                        <button type="submit" id="confirm-assign-btn" class="action-button primary-action-btn" disabled>Confirm Assignment</button>
                    </div>
                </div>`, 'max-w-md');

                const selectEl = document.getElementById('agent-select');
                const confirmBtn = document.getElementById('confirm-assign-btn');

                selectEl.addEventListener('change', () => {
                    confirmBtn.disabled = !selectEl.value;
                });

                document.getElementById('cancel-modal-btn').addEventListener('click', closeModal);
                confirmBtn.addEventListener('click', () => {
                    const selectedOption = selectEl.options[selectEl.selectedIndex];
                    if (selectedOption && selectedOption.value) {
                        const agentDetails = {
                            id: selectedOption.value,
                            name: selectedOption.dataset.name
                        };
                        updateLeadStatus(leadId, { status: 'active', assignedAgentId: agentDetails.id, assignedAgentName: agentDetails.name }).then(() => {
                            closeModal();
                            document.querySelector('.nav-link.active')?.click();
                        });
                    }
                });
            } catch (error) {
                displayError("Could not fetch agent list. This is likely a Firestore security rule or indexing issue.", error);
            }
        }

        function showAddLeadModal() {
             openModal(`<div class="p-8"><div class="flex justify-between items-center"><h3 class="text-xl font-semibold">Add New Lead</h3><button id="close-modal-btn" class="p-1 rounded-full hover:bg-gray-100 text-gray-500 hover:text-gray-800">&times;</button></div><p class="text-sm text-gray-500 font-light mt-1 mb-6">Fill in the information below to add a new lead.</p>
                <form id="add-lead-form">
                    <div class="grid grid-cols-2 gap-x-6 gap-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                            <input name="name" type="text" placeholder="John Doe" class="w-full p-3 border border-gray-300 bg-white rounded-md font-light" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input name="email" type="email" placeholder="email@example.com" class="w-full p-3 border border-gray-300 bg-white rounded-md font-light" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Company Name</label>
                            <input name="companyName" type="text" placeholder="Innovate Inc." class="w-full p-3 border border-gray-300 bg-white rounded-md font-light" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Designation</label>
                            <input name="title" type="text" placeholder="Marketing Director" class="w-full p-3 border border-gray-300 bg-white rounded-md font-light" required>
                        </div>
                        <div class="relative">
                             <label class="block text-sm font-medium text-gray-700 mb-1">Company Website</label>
                            <input name="companyWebsite" id="company-website-input" type="text" placeholder="example.com" class="w-full p-3 border border-gray-300 bg-white rounded-md font-light" required>
                            <span id="website-validation-icon" class="absolute right-3 top-9"></span>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                            <input name="phoneNumber" type="tel" placeholder="9876543210" class="w-full p-3 border border-gray-300 bg-white rounded-md font-light" required>
                        </div>
                    </div>
                    <div class="pt-6 flex justify-end space-x-3">
                        <button type="button" id="cancel-modal-btn" class="action-button">Cancel</button>
                        <button type="submit" class="action-button primary-action-btn">Add Lead</button>
                    </div>
                </form>
             </div>`, 'max-w-3xl');
            
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            document.getElementById('cancel-modal-btn').addEventListener('click', closeModal);

            const websiteInput = document.getElementById('company-website-input');
            const validationIcon = document.getElementById('website-validation-icon');

            websiteInput.addEventListener('blur', (e) => {
                const url = e.target.value.trim();
                validationIcon.innerHTML = ''; // Clear previous icon
                if (!url) return;

                const isValid = /^[a-zA-Z0-9-]+\.[a-zA-Z]{2,}$/.test(url) || /^(?:[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?\.)+[a-z0-9][a-z0-9-]{0,61}[a-z0-9]$/.test(url);

                validationIcon.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 text-gray-400 animate-spin"></i>`;
                lucide.createIcons();

                setTimeout(() => {
                    if (isValid) {
                        validationIcon.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>`;
                        websiteInput.dataset.isValid = "true";
                    } else {
                        validationIcon.innerHTML = `<i data-lucide="x-circle" class="w-5 h-5 text-red-500"></i>`;
                        websiteInput.dataset.isValid = "false";
                    }
                    lucide.createIcons();
                }, 500);
            });

            document.getElementById('add-lead-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                if (websiteInput.dataset.isValid === "false") {
                    const customAlert = document.createElement('div');
                    customAlert.className = 'fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg animate-pulse';
                    customAlert.innerText = 'Please enter a valid website address.';
                    document.body.appendChild(customAlert);
                    setTimeout(() => customAlert.remove(), 3000);
                    return;
                }

                const formData = new FormData(e.target);
                let website = formData.get('companyWebsite').trim();
                if (website && !/^https?:\/\//i.test(website)) {
                    website = 'https://' + website;
                }

                const leadData = {
                    name: formData.get('name'),
                    phone: formData.get('phoneNumber'),
                    email: formData.get('email'),
                    companyName: formData.get('companyName'),
                    companyWebsite: website,
                    title: formData.get('title'),
                    country: 'Unknown',
                    leadSource: 'Manual',
                    leadValue: 0,
                    status: 'active', // New leads are active by default
                    assignedAgentId: null, // New leads are unassigned
                    assignedAgentName: null,
                };
                
                const leadsRef = collection(db, 'users', userId, 'leads');
                try { 
                    await addDoc(leadsRef, { ...leadData, createdAt: new Date(), notes: [], appointments: [] }); 
                    closeModal(); 
                } 
                catch (error) { 
                    displayError("Failed to add lead.", error);
                }
            });
        }
        async function triggerAINurturing(lead) {
            // This function is now called after the lead status is updated, so we re-open a new modal.
            openModal(`<div class="p-8"><h3 class="text-xl font-semibold mb-4">AI Nurturing Sequence</h3><p class="text-sm text-gray-500 mb-4">Generating personalized outreach for ${lead.name}...</p><textarea id="ai-outreach-content" class="w-full h-48 p-3 border border-gray-300 bg-gray-50 rounded-md font-light" readonly>Generating...</textarea><div class="flex justify-end space-x-3 mt-4"><button id="close-ai-modal-btn" class="action-button">Close</button><button id="send-outreach-btn" class="action-button primary-action-btn" disabled><i data-lucide="${lead.country?.toLowerCase() === 'india' ? 'message-circle' : 'mail'}" class="w-4 h-4 mr-2"></i>Send</button></div></div>`);
            
            const outreachContentEl = document.getElementById('ai-outreach-content');
            const sendBtn = document.getElementById('send-outreach-btn');
            const closeBtn = document.getElementById('close-ai-modal-btn');
            closeBtn.addEventListener('click', closeModal);

            const notesText = lead.notes?.map(n => n.text).join('\n') || "No call notes available.";
            const prompt = `Analyze the following lead information and generate a personalized follow-up message. The goal is to re-engage this "cold" lead by providing value and showing you understand their business. LEAD DETAILS: - Contact: ${lead.name} - Company: ${lead.companyName} - Country: ${lead.country} - Call Notes: ${notesText} INSTRUCTIONS: 1. Infer the lead's potential business needs. 2. Write a short, professional, and friendly message. 3. Tailor for ${lead.country?.toLowerCase() === 'india' ? 'WhatsApp' : 'Email'}. 4. End with a soft call-to-action.`;

            try {
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const response = await fetch(apiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API error: ${response.statusText} - ${errorBody}`);
                }
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (outreachContentEl) outreachContentEl.value = text;
                    if (sendBtn) {
                        sendBtn.disabled = false;
                        sendBtn.addEventListener('click', () => { console.log(`Simulated sending to ${lead.name}`); closeModal(); });
                    }
                } else {
                    throw new Error("Unexpected API response structure.");
                }
            } catch (error) {
                console.error("Gemini API error:", error);
                if (outreachContentEl) outreachContentEl.value = 'Failed to generate AI message. Check console for details.';
            }
        }

        function showLogInteractionModal() {
            openModal(`<div class="p-8"><h3 class="text-xl font-semibold mb-6">Log an Interaction</h3><div class="mb-4"><label class="block text-sm font-medium text-gray-600 mb-1">Find Lead</label><input id="log-interaction-search" type="text" placeholder="Search by name or company..." class="w-full p-3 border border-gray-300 bg-white rounded-md font-light"><div id="log-interaction-results" class="mt-2"></div></div><div class="mb-4"><label class="block text-sm font-medium text-gray-600 mb-1">Notes</label><textarea id="log-interaction-notes" class="w-full p-3 border border-gray-300 bg-white rounded-md font-light" rows="4" placeholder="Add call notes or meeting summary..."></textarea></div><div class="flex justify-end space-x-3 mt-8"><button type="button" id="cancel-modal-btn" class="action-button">Cancel</button><button type="submit" id="log-interaction-submit" class="action-button primary-action-btn" disabled>Log Interaction</button></div></div>`, 'max-w-lg');
            
            const searchInput = document.getElementById('log-interaction-search');
            const resultsDiv = document.getElementById('log-interaction-results');
            const submitBtn = document.getElementById('log-interaction-submit');
            const notesText = document.getElementById('log-interaction-notes');
            let selectedLeadId = null;

            searchInput.addEventListener('keyup', async (e) => {
                const searchTerm = e.target.value.toLowerCase();
                if (searchTerm.length < 2) { resultsDiv.innerHTML = ''; return; }
                
                const leadsRef = collection(db, 'users', userId, 'leads');
                const snapshot = await getDocs(leadsRef);
                const results = [];
                snapshot.docs.forEach(doc => {
                    const lead = { id: doc.id, ...doc.data() };
                    if (lead.name.toLowerCase().includes(searchTerm) || lead.companyName.toLowerCase().includes(searchTerm)) {
                        results.push(lead);
                    }
                });

                resultsDiv.innerHTML = results.map(lead => `<div class="p-2 hover:bg-gray-100 cursor-pointer rounded" data-id="${lead.id}" data-name="${lead.name}">${lead.name} (${lead.companyName})</div>`).join('');
                
                resultsDiv.querySelectorAll('div').forEach(item => {
                    item.addEventListener('click', () => {
                        selectedLeadId = item.dataset.id;
                        searchInput.value = item.dataset.name;
                        resultsDiv.innerHTML = '';
                        submitBtn.disabled = false;
                    });
                });
            });

            document.getElementById('cancel-modal-btn').addEventListener('click', closeModal);
            submitBtn.addEventListener('click', async () => {
                if (!selectedLeadId || !notesText.value.trim()) return;
                const leadRef = doc(db, 'users', userId, 'leads', selectedLeadId);
                const newNote = { text: notesText.value, timestamp: new Date() };
                await updateDoc(leadRef, { notes: arrayUnion(newNote) });
                closeModal();
            });
        }

        function showAIAssistantModal() {
            openModal(`<div class="p-8"><h3 class="text-xl font-semibold mb-6">AI Assistant</h3><div class="mb-4"><textarea id="ai-assistant-prompt" class="w-full p-3 border border-gray-300 bg-white rounded-md font-light" rows="3" placeholder="Ask the AI anything... e.g., 'Draft a follow-up for John Smith'"></textarea></div><div class="mb-4 bg-gray-50 p-4 rounded-md min-h-[100px]" id="ai-assistant-response"></div><div class="flex justify-end space-x-3 mt-8"><button type="button" id="cancel-modal-btn" class="action-button">Close</button><button type="submit" id="ai-assistant-submit" class="action-button primary-action-btn">Generate</button></div></div>`, 'max-w-lg');
            
            document.getElementById('cancel-modal-btn').addEventListener('click', closeModal);
            document.getElementById('ai-assistant-submit').addEventListener('click', async () => {
                const promptInput = document.getElementById('ai-assistant-prompt');
                const responseDiv = document.getElementById('ai-assistant-response');
                const prompt = promptInput.value;
                if (!prompt.trim()) return;

                responseDiv.innerHTML = 'Generating...';
                try {
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                    if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                    const result = await response.json();
                    const text = result.candidates[0].content.parts[0].text;
                    responseDiv.innerText = text;
                } catch (error) {
                    console.error("AI Assistant Error:", error);
                    responseDiv.innerText = 'Failed to get a response from the AI.';
                }
            });
        }
        
        function renderReportsPage() {
            mainContent.innerHTML = `
                <h2 class="text-3xl font-light text-gray-800 mb-6">Reports Center</h2>
                <div class="space-y-8">
                    <div class="bg-white p-6 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-semibold mb-4">Export Data</h3>
                        <p class="text-sm text-gray-600 mb-4">Download a complete CSV file of all your lead data.</p>
                        <button id="export-csv-btn" class="action-button primary-action-btn">Export All Data (CSV)</button>
                    </div>
                    <div class="bg-white p-6 rounded-lg border border-gray-200">
                         <h3 class="text-lg font-semibold mb-4">AI-Powered Report Enhancement</h3>
                         <p class="text-sm text-gray-600 mb-6">Our AI analyzes your report data to provide strategic recommendations and insights that you might have missed.</p>
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold">Smart Summaries</h4>
                                <p class="text-xs text-gray-500 mt-1">Automatically generate executive summaries highlighting the most important insights from your data.</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold">Competitive Analysis</h4>
                                <p class="text-xs text-gray-500 mt-1">Compare performance against industry benchmarks and competitors with AI-generated insights.</p>
                            </div>
                             <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold">Predictive Trends</h4>
                                <p class="text-xs text-gray-500 mt-1">Identify emerging patterns and predict future performance based on historical data analysis.</p>
                            </div>
                         </div>
                         <button id="enable-ai-enhancement" class="action-button bg-purple-600 text-white hover:bg-purple-500 border-purple-600 w-full">Enable AI Enhancement</button>
                    </div>
                </div>
            `;
            document.getElementById('export-csv-btn').addEventListener('click', exportDataToCSV);
        }

        async function exportDataToCSV() {
            const leadsRef = collection(db, 'users', userId, 'leads');
            const snapshot = await getDocs(leadsRef);
            const leads = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            let csvContent = "data:text/csv;charset=utf-8,";
            const headers = ["ID", "Name", "Company", "Email", "Phone", "Status", "Value (INR)", "Assigned To", "Source", "Created At"];
            csvContent += headers.join(",") + "\r\n";

            leads.forEach(lead => {
                const row = [
                    lead.id,
                    `"${lead.name || ''}"`,
                    `"${lead.companyName || ''}"`,
                    lead.email || '',
                    `"${lead.phone || ''}"`,
                    lead.status || '',
                    lead.leadValue || 0,
                    `"${lead.assignedAgentName || 'Unassigned'}"`,
                    lead.leadSource || '',
                    lead.createdAt.toDate().toLocaleString()
                ];
                csvContent += row.join(",") + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "lead_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function renderAIStrategicAssistant() {
            return `
                <div class="bg-white p-6 rounded-lg border border-gray-200">
                    <div class="flex items-center mb-4">
                        <i data-lucide="sparkles" class="w-6 h-6 text-purple-500 mr-3"></i>
                        <h3 class="text-lg font-semibold">AI Strategic Assistant <span class="text-xs bg-blue-100 text-blue-800 font-semibold px-2 py-1 rounded-full ml-2">Beta</span></h3>
                    </div>
                     <p class="text-sm text-gray-600 mb-4">Ask questions about your sales pipeline and get AI-powered insights.</p>
                    <div class="flex space-x-2">
                        <input id="ai-assistant-input" type="text" placeholder="e.g., Which lead source converts the fastest?" class="w-full p-3 border border-gray-300 rounded-lg text-sm font-light h-12">
                        <button id="ai-assistant-analyze-btn" class="action-button primary-action-btn h-12">Analyze</button>
                    </div>
                     <div class="mt-4">
                        <p class="text-xs text-gray-500 mb-2">Quick questions:</p>
                        <div class="grid grid-cols-2 gap-2">
                           <button class="action-button quick-question-btn text-xs h-12">Which lead source converts the fastest?</button>
                           <button class="action-button quick-question-btn text-xs h-12">How can I shorten my sales cycle?</button>
                           <button class="action-button quick-question-btn text-xs h-12">What's my highest-performing sales rep?</button>
                           <button class="action-button quick-question-btn text-xs h-12">What stage are most deals getting stuck in?</button>
                        </div>
                    </div>
                    <div id="ai-assistant-response" class="mt-4 p-4 bg-gray-50 rounded-lg min-h-[60px] text-sm font-light"></div>
                </div>
            `;
        }

        function addAIAssistantListeners() {
            const analyzeBtn = document.getElementById('ai-assistant-analyze-btn');
            const inputEl = document.getElementById('ai-assistant-input');
            const responseEl = document.getElementById('ai-assistant-response');
            
            const getAIStrategy = async (prompt) => {
                responseEl.textContent = 'Analyzing...';
                
                const leadsRef = collection(db, 'users', userId, 'leads');
                const snapshot = await getDocs(leadsRef);
                const allLeads = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

                let dataSummary = "General CRM data: ";
                if (prompt.toLowerCase().includes("fastest")) {
                    const sourceConversion = {};
                    allLeads.filter(l => l.status === 'won' && l.createdAt).forEach(l => {
                        const created = l.createdAt.toMillis();
                        // Assume a 'wonAt' field exists, or approximate with now
                        const wonAt = l.wonAt?.toMillis() || Date.now();
                        const duration = (wonAt - created) / (1000 * 60 * 60 * 24); // duration in days
                        if (!sourceConversion[l.leadSource]) {
                            sourceConversion[l.leadSource] = { totalDuration: 0, count: 0 };
                        }
                        sourceConversion[l.leadSource].totalDuration += duration;
                        sourceConversion[l.leadSource].count++;
                    });
                    dataSummary = "Based on my data, here are the average conversion times (in days) for each lead source: ";
                    for(const source in sourceConversion) {
                        dataSummary += `${source}: ${(sourceConversion[source].totalDuration / sourceConversion[source].count).toFixed(1)} days. `;
                    }
                }

                try {
                    const apiKey = ""; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const fullPrompt = `As a sales strategy expert, answer the following question based on this data: ${dataSummary}\n\nQuestion: ${prompt}`;
                    const payload = { contents: [{ parts: [{ text: fullPrompt }] }] };
                    const response = await fetch(apiUrl, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload) 
                    });
                    if (!response.ok) throw new Error('API Error');
                    const result = await response.json();
                    responseEl.textContent = result.candidates[0].content.parts[0].text;
                } catch (error) {
                    console.error("AI Assistant Error:", error);
                    responseEl.textContent = 'Sorry, I could not process that request.';
                }
            };
            
            analyzeBtn.addEventListener('click', () => {
                if(inputEl.value) getAIStrategy(inputEl.value);
            });

            document.querySelectorAll('.quick-question-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    inputEl.value = btn.textContent;
                    getAIStrategy(btn.textContent);
                });
            });
        }
        
        function renderHelpPage() {
            mainContent.innerHTML = `
                <h2 class="text-3xl font-light text-gray-800 mb-6">Help Center</h2>
                <div class="space-y-8">
                    <div class="bg-white p-6 rounded-lg border border-gray-200">
                        <h3 class="text-xl font-semibold mb-4">Onboarding Guide</h3>
                        <div class="space-y-4">
                            <div class="flex items-start"><i data-lucide="user-plus" class="w-5 h-5 mr-4 mt-1 text-blue-500"></i><div><h4 class="font-semibold">Step 1: Create a Lead</h4><p class="text-sm text-gray-600">Use the floating action button in the bottom-left corner to add new leads to the system.</p></div></div>
                            <div class="flex items-start"><i data-lucide="users" class="w-5 h-5 mr-4 mt-1 text-blue-500"></i><div><h4 class="font-semibold">Step 2: Assign a Lead (Managers)</h4><p class="text-sm text-gray-600">Navigate to "All Leads" > "New" tab. Click the "Assign" button on a lead card to assign it to an agent.</p></div></div>
                            <div class="flex items-start"><i data-lucide="pen-square" class="w-5 h-5 mr-4 mt-1 text-blue-500"></i><div><h4 class="font-semibold">Step 3: Update Lead Status</h4><p class="text-sm text-gray-600">Click on any lead card to open the detail view. Use the action buttons to mark the lead as Won, Cold, or Lost.</p></div></div>
                             <div class="flex items-start"><i data-lucide="calendar-plus" class="w-5 h-5 mr-4 mt-1 text-blue-500"></i><div><h4 class="font-semibold">Step 4: Schedule a Meeting</h4><p class="text-sm text-gray-600">In the lead detail view, click "Schedule Meeting" to open a form. Fill in the details to generate a Google Calendar invite link.</p></div></div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg border border-gray-200">
                        <h3 class="text-xl font-semibold mb-4">Frequently Asked Questions</h3>
                        <div id="faq-container" class="space-y-2"></div>
                    </div>
                     <div class="bg-white p-6 rounded-lg border border-gray-200">
                        <h3 class="text-xl font-semibold mb-4">Still Need Help?</h3>
                        <p class="text-sm text-gray-600 mb-4">If you can't find the answer you're looking for, create a support ticket and our team will get back to you.</p>
                        <button id="create-ticket-btn" class="action-button primary-action-btn">Create a Support Ticket</button>
                    </div>
                </div>
            `;
            const faqs = [
                { q: "How do I find unassigned leads?", a: "Go to the 'All Leads' page from the main navigation. The 'New' tab, which is active by default, shows all unassigned leads." },
                { q: "Where do I see leads I've won?", a: "On the 'All Leads' page, click the 'Won' tab to see a list of all your successfully closed deals." },
                { q: "Can I export my data?", a: "Yes. Navigate to the 'Reports' page, where you will find an 'Export All Data (CSV)' button." },
                { q: "How does the AI Assistant work?", a: "The AI Assistant on your dashboard can answer strategic questions about your sales data. It analyzes your team's performance to provide data-driven insights, not generic advice." }
            ];
            const faqContainer = document.getElementById('faq-container');
            faqs.forEach(faq => {
                const item = document.createElement('div');
                item.className = 'faq-item border-b border-gray-200 last:border-b-0 py-3';
                item.innerHTML = `
                    <button class="w-full text-left flex justify-between items-center">
                        <span class="font-medium">${faq.q}</span>
                        <i data-lucide="chevron-down" class="faq-chevron w-5 h-5 transition-transform"></i>
                    </button>
                    <div class="faq-answer pt-2 text-sm text-gray-600">
                        ${faq.a}
                    </div>
                `;
                faqContainer.appendChild(item);
            });

            faqContainer.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const item = button.closest('.faq-item');
                item.classList.toggle('open');
            });
            
            document.getElementById('create-ticket-btn').addEventListener('click', showCreateTicketModal);

            lucide.createIcons();
        }

        function showScheduleMeetingModal(leadId, leadEmail) {
            openModal(`<div class="p-8"><h3 class="text-xl font-semibold mb-6">Schedule a Meeting</h3><form id="schedule-meeting-form" class="space-y-4"><div><label class="block text-sm font-medium text-gray-600 mb-1">Title</label><input name="title" type="text" class="w-full p-3 border border-gray-300 rounded-md font-light h-12"></div><div><label class="block text-sm font-medium text-gray-600 mb-1">Date & Time</label><input name="date" type="datetime-local" class="w-full p-3 border border-gray-300 rounded-md font-light h-12"></div><div><label class="block text-sm font-medium text-gray-600 mb-1">Description / Notes</label><textarea name="notes" class="w-full p-3 border border-gray-300 rounded-md font-light" rows="3"></textarea></div><div class="flex justify-end space-x-3 mt-8"><button type="button" id="cancel-modal-btn" class="action-button">Cancel</button><button type="submit" class="action-button primary-action-btn">Generate Calendar Link</button></div></form></div>`, 'max-w-lg');
            
            document.getElementById('cancel-modal-btn').addEventListener('click', closeModal);
            
            document.getElementById('schedule-meeting-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const title = encodeURIComponent(formData.get('title'));
                const notes = encodeURIComponent(formData.get('notes'));
                const dateTime = new Date(formData.get('date'));
                
                // Format for Google Calendar (YYYYMMDDTHHMMSSZ)
                const startTime = dateTime.toISOString().replace(/-|:|\.\d{3}/g, '');
                const endTime = new Date(dateTime.getTime() + 60*60000).toISOString().replace(/-|:|\.\d{3}/g, ''); // Add 1 hour duration
                const dates = `${startTime}/${endTime}`;

                const googleCalendarUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${dates}&details=${notes}&add=${leadEmail}`;
                
                window.open(googleCalendarUrl, '_blank');
                
                const appointmentData = { date: dateTime.toISOString(), notes: formData.get('notes') };
                const leadRef = doc(db, 'users', userId, 'leads', leadId);
                await updateDoc(leadRef, { appointments: arrayUnion(appointmentData) });

                closeModal();
            });
        }
        
        function showCreateTicketModal() {
            openModal(`<div class="p-8"><h3 class="text-xl font-semibold mb-6">Create Support Ticket</h3><form id="create-ticket-form" class="space-y-4"><div><label class="block text-sm font-medium text-gray-600 mb-1">Subject</label><input name="subject" type="text" class="w-full p-3 border border-gray-300 rounded-md font-light" required></div><div><label class="block text-sm font-medium text-gray-600 mb-1">Describe your issue</label><textarea name="description" class="w-full p-3 border border-gray-300 rounded-md font-light" rows="5" required></textarea></div><div class="flex justify-end space-x-3 mt-8"><button type="button" id="cancel-modal-btn" class="action-button">Cancel</button><button type="submit" class="action-button primary-action-btn">Submit Ticket</button></div></form></div>`, 'max-w-lg');
            
            document.getElementById('cancel-modal-btn').addEventListener('click', closeModal);
            
            document.getElementById('create-ticket-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const subject = e.target.subject.value;
                const description = e.target.description.value;
                console.log("New Support Ticket:", { subject, description, user: auth.currentUser.email });
                closeModal();
                alert("Thank you! Your support ticket has been submitted.");
            });
        }


        // --- START THE APP ---
        window.onload = initialize;
    </script>
</body>
</html>
